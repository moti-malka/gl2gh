# Plan.json Schema - Complete Action Plan Specification

## Overview
The `plan.json` file is the executable migration plan generated by the Plan Agent. It contains an ordered list of atomic actions that the Apply Agent will execute to migrate all components from GitLab to GitHub.

## Design Principles
1. **Atomic Actions**: Each action is independently executable
2. **Idempotency**: Actions can be safely retried
3. **Dependencies**: Actions declare what must complete before them
4. **Deterministic**: Same inputs always produce same plan
5. **Safe**: Default is dry-run preview, not execution

## Schema

```json
{
  "version": "1.0",
  "run_id": "507f1f77bcf86cd799439011",
  "project_id": "507f1f77bcf86cd799439012",
  "gitlab_project": "namespace/project",
  "github_target": "org/repo",
  "created_at": "2024-01-15T10:00:00Z",
  "mode": "PLAN_ONLY",
  
  "summary": {
    "total_actions": 156,
    "actions_by_type": {
      "repo_create": 1,
      "repo_push": 1,
      "lfs_configure": 1,
      "workflow_commit": 5,
      "environment_create": 3,
      "secret_set": 12,
      "label_create": 15,
      "milestone_create": 4,
      "issue_create": 45,
      "pr_create": 12,
      "release_create": 8,
      "package_publish": 3,
      "protection_set": 2,
      "webhook_create": 1,
      "artifact_commit": 1
    },
    "estimated_duration_minutes": 45,
    "requires_user_input": true,
    "blocking_issues": []
  },
  
  "user_inputs_required": [
    {
      "type": "secret_value",
      "key": "DATABASE_URL",
      "scope": "repository",
      "reason": "GitLab variable was masked, value not retrievable",
      "required": true
    },
    {
      "type": "user_mapping",
      "gitlab_user": "olduser",
      "reason": "No automatic match found",
      "required": false,
      "fallback": "text_attribution"
    }
  ],
  
  "actions": [
    {
      "id": "action-001",
      "type": "repo_create",
      "component": "repository",
      "phase": "foundation",
      "description": "Create GitHub repository",
      "dependencies": [],
      "idempotency_key": "repo-create-org-repo",
      "parameters": {
        "org": "myorg",
        "name": "myrepo",
        "description": "Migrated from GitLab",
        "private": true,
        "has_issues": true,
        "has_projects": true,
        "has_wiki": true
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 5
    },
    
    {
      "id": "action-002",
      "type": "repo_push",
      "component": "repository",
      "phase": "foundation",
      "description": "Push git bundle to GitHub",
      "dependencies": ["action-001"],
      "idempotency_key": "repo-push-org-repo-sha256abc",
      "parameters": {
        "bundle_path": "export/namespace/project/repo.bundle",
        "target_repo": "org/repo",
        "force": false
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 120
    },
    
    {
      "id": "action-003",
      "type": "lfs_configure",
      "component": "repository",
      "phase": "foundation",
      "description": "Configure Git LFS and push objects",
      "dependencies": ["action-002"],
      "idempotency_key": "lfs-configure-org-repo",
      "parameters": {
        "lfs_objects_path": "export/namespace/project/lfs/",
        "target_repo": "org/repo"
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 180,
      "skip_if": {
        "condition": "no_lfs",
        "check": "lfs_objects_count == 0"
      }
    },
    
    {
      "id": "action-010",
      "type": "workflow_commit",
      "component": "ci",
      "phase": "ci_setup",
      "description": "Commit workflow: ci.yml",
      "dependencies": ["action-002"],
      "idempotency_key": "workflow-commit-ci-yml-sha256xyz",
      "parameters": {
        "workflow_path": "transform/namespace/project/workflows/ci.yml",
        "target_path": ".github/workflows/ci.yml",
        "target_repo": "org/repo",
        "branch": "main",
        "commit_message": "Add CI workflow (migrated from GitLab CI)"
      },
      "dry_run_safe": false,
      "reversible": true,
      "estimated_duration_seconds": 10
    },
    
    {
      "id": "action-011",
      "type": "environment_create",
      "component": "ci",
      "phase": "ci_setup",
      "description": "Create environment: production",
      "dependencies": ["action-001"],
      "idempotency_key": "env-create-production",
      "parameters": {
        "target_repo": "org/repo",
        "environment_name": "production",
        "wait_timer": 0,
        "reviewers": [],
        "deployment_branch_policy": "protected"
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 5
    },
    
    {
      "id": "action-012",
      "type": "secret_set",
      "component": "ci",
      "phase": "ci_setup",
      "description": "Set secret: DATABASE_URL (production)",
      "dependencies": ["action-011"],
      "idempotency_key": "secret-set-production-DATABASE_URL",
      "parameters": {
        "target_repo": "org/repo",
        "secret_name": "DATABASE_URL",
        "scope": "environment",
        "environment": "production",
        "value": "${USER_INPUT_REQUIRED}",
        "value_source": "user_input"
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 3,
      "requires_user_input": true
    },
    
    {
      "id": "action-020",
      "type": "label_create",
      "component": "issues",
      "phase": "issue_setup",
      "description": "Create label: bug",
      "dependencies": ["action-001"],
      "idempotency_key": "label-create-bug",
      "parameters": {
        "target_repo": "org/repo",
        "name": "bug",
        "color": "d73a4a",
        "description": "Something isn't working"
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 2
    },
    
    {
      "id": "action-030",
      "type": "milestone_create",
      "component": "issues",
      "phase": "issue_setup",
      "description": "Create milestone: v1.0",
      "dependencies": ["action-001"],
      "idempotency_key": "milestone-create-v1.0",
      "parameters": {
        "target_repo": "org/repo",
        "title": "v1.0",
        "description": "First release",
        "due_on": "2024-06-30T00:00:00Z",
        "state": "open"
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 2
    },
    
    {
      "id": "action-040",
      "type": "issue_create",
      "component": "issues",
      "phase": "issue_import",
      "description": "Import issue #1: Fix login bug",
      "dependencies": ["action-020", "action-030"],
      "idempotency_key": "issue-create-1",
      "parameters": {
        "target_repo": "org/repo",
        "gitlab_issue_iid": 1,
        "title": "Fix login bug",
        "body": "_Originally created by @johndoe on 2024-01-10_\n\nLogin fails when...",
        "labels": ["bug"],
        "milestone": "v1.0",
        "assignees": ["johndoe"],
        "state": "open",
        "comments": [
          {
            "body": "_Originally by @janedoe on 2024-01-11_\n\nI can reproduce this...",
            "created_at": "2024-01-11T10:00:00Z"
          }
        ]
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 5
    },
    
    {
      "id": "action-100",
      "type": "pr_create",
      "component": "pull_requests",
      "phase": "pr_import",
      "description": "Import MR !1 as PR: Add authentication",
      "dependencies": ["action-002", "action-020"],
      "idempotency_key": "pr-create-1",
      "parameters": {
        "target_repo": "org/repo",
        "gitlab_mr_iid": 1,
        "title": "Add authentication",
        "body": "_Originally by @johndoe on 2024-01-05_\n\nThis PR adds...",
        "head": "feature/auth",
        "base": "main",
        "labels": ["enhancement"],
        "reviewers": ["janedoe"],
        "state": "open",
        "comments": [],
        "ensure_branch_exists": true
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 10
    },
    
    {
      "id": "action-120",
      "type": "wiki_push",
      "component": "wiki",
      "phase": "wiki_import",
      "description": "Push wiki pages to GitHub wiki",
      "dependencies": ["action-001"],
      "idempotency_key": "wiki-push-org-repo",
      "parameters": {
        "wiki_bundle_path": "export/namespace/project/wiki.bundle",
        "target_repo": "org/repo"
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 30,
      "skip_if": {
        "condition": "no_wiki",
        "check": "wiki_pages_count == 0"
      }
    },
    
    {
      "id": "action-130",
      "type": "release_create",
      "component": "releases",
      "phase": "release_import",
      "description": "Create release: v1.0.0",
      "dependencies": ["action-002"],
      "idempotency_key": "release-create-v1.0.0",
      "parameters": {
        "target_repo": "org/repo",
        "tag_name": "v1.0.0",
        "name": "Version 1.0.0",
        "body": "Release notes...",
        "draft": false,
        "prerelease": false,
        "assets": [
          {
            "name": "app-linux.tar.gz",
            "path": "export/namespace/project/releases/v1.0.0/app-linux.tar.gz",
            "content_type": "application/gzip"
          }
        ]
      },
      "dry_run_safe": false,
      "reversible": true,
      "estimated_duration_seconds": 20
    },
    
    {
      "id": "action-140",
      "type": "package_publish",
      "component": "packages",
      "phase": "package_import",
      "description": "Publish container: myapp:latest",
      "dependencies": ["action-001"],
      "idempotency_key": "package-publish-myapp-latest",
      "parameters": {
        "type": "container",
        "source_image": "registry.gitlab.com/namespace/project/myapp:latest",
        "target_image": "ghcr.io/org/repo/myapp:latest",
        "local_path": "export/namespace/project/packages/myapp-latest.tar"
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 300,
      "skip_if": {
        "condition": "no_packages",
        "check": "package_count == 0"
      }
    },
    
    {
      "id": "action-150",
      "type": "protection_set",
      "component": "settings",
      "phase": "governance",
      "description": "Set branch protection: main",
      "dependencies": ["action-002"],
      "idempotency_key": "protection-set-main",
      "parameters": {
        "target_repo": "org/repo",
        "branch": "main",
        "required_status_checks": {
          "strict": true,
          "contexts": ["ci"]
        },
        "enforce_admins": true,
        "required_pull_request_reviews": {
          "required_approving_review_count": 1,
          "dismiss_stale_reviews": true
        },
        "restrictions": null,
        "allow_force_pushes": false,
        "allow_deletions": false
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 5
    },
    
    {
      "id": "action-160",
      "type": "webhook_create",
      "component": "webhooks",
      "phase": "integrations",
      "description": "Create webhook: CI notification",
      "dependencies": ["action-001"],
      "idempotency_key": "webhook-create-ci-notify",
      "parameters": {
        "target_repo": "org/repo",
        "url": "https://ci.example.com/webhook",
        "content_type": "json",
        "secret": "${USER_INPUT_REQUIRED}",
        "events": ["push", "pull_request"],
        "active": true
      },
      "dry_run_safe": true,
      "reversible": true,
      "estimated_duration_seconds": 3,
      "requires_user_input": true
    },
    
    {
      "id": "action-170",
      "type": "artifact_commit",
      "component": "preservation",
      "phase": "preservation",
      "description": "Commit migration artifacts",
      "dependencies": ["action-002"],
      "idempotency_key": "artifact-commit-migration",
      "parameters": {
        "target_repo": "org/repo",
        "source_path": "export/namespace/project/pipelines/",
        "target_path": "migration/gitlab-pipelines/",
        "branch": "main",
        "commit_message": "Add GitLab pipeline history (preserved)"
      },
      "dry_run_safe": false,
      "reversible": false,
      "estimated_duration_seconds": 15
    }
  ],
  
  "phases": [
    {
      "name": "foundation",
      "description": "Create repository and push code",
      "actions": ["action-001", "action-002", "action-003"],
      "order": 1
    },
    {
      "name": "ci_setup",
      "description": "Set up CI/CD workflows and environments",
      "actions": ["action-010", "action-011", "action-012"],
      "order": 2
    },
    {
      "name": "issue_setup",
      "description": "Create labels and milestones",
      "actions": ["action-020", "action-030"],
      "order": 3
    },
    {
      "name": "issue_import",
      "description": "Import issues",
      "actions": ["action-040"],
      "order": 4,
      "parallel_safe": true
    },
    {
      "name": "pr_import",
      "description": "Import pull requests",
      "actions": ["action-100"],
      "order": 5,
      "parallel_safe": true
    },
    {
      "name": "wiki_import",
      "description": "Import wiki",
      "actions": ["action-120"],
      "order": 6
    },
    {
      "name": "release_import",
      "description": "Import releases",
      "actions": ["action-130"],
      "order": 7
    },
    {
      "name": "package_import",
      "description": "Publish packages",
      "actions": ["action-140"],
      "order": 8
    },
    {
      "name": "governance",
      "description": "Set protections and permissions",
      "actions": ["action-150"],
      "order": 9
    },
    {
      "name": "integrations",
      "description": "Configure webhooks",
      "actions": ["action-160"],
      "order": 10
    },
    {
      "name": "preservation",
      "description": "Commit preservation artifacts",
      "actions": ["action-170"],
      "order": 11
    }
  ],
  
  "validation": {
    "all_dependencies_resolvable": true,
    "no_circular_dependencies": true,
    "all_required_inputs_identified": true,
    "estimated_github_api_calls": 234,
    "estimated_rate_limit_buffer": "sufficient"
  },
  
  "metadata": {
    "generated_by": "PlanAgent",
    "generator_version": "1.0",
    "gitlab_version": "16.5.0",
    "github_api_version": "2022-11-28"
  }
}
```

## Action Types

### Repository Actions
- `repo_create` - Create GitHub repository
- `repo_push` - Push git bundle
- `repo_configure` - Update repository settings
- `lfs_configure` - Set up Git LFS

### CI/CD Actions
- `workflow_commit` - Commit workflow file
- `environment_create` - Create environment
- `secret_set` - Set secret or variable
- `schedule_create` - Create workflow schedule

### Issue Actions
- `label_create` - Create label
- `milestone_create` - Create milestone
- `issue_create` - Import issue

### Pull Request Actions
- `pr_create` - Import merge request as PR
- `pr_comment_add` - Add comment to PR

### Wiki Actions
- `wiki_push` - Push wiki repository
- `wiki_commit` - Commit to docs folder

### Release Actions
- `release_create` - Create release
- `release_asset_upload` - Upload release asset

### Package Actions
- `package_publish` - Publish package to GHCR/Packages

### Settings Actions
- `protection_set` - Set branch protection
- `collaborator_add` - Add collaborator
- `team_create` - Create team
- `codeowners_commit` - Commit CODEOWNERS file

### Webhook Actions
- `webhook_create` - Create webhook
- `webhook_configure` - Configure webhook

### Preservation Actions
- `artifact_commit` - Commit preservation artifacts

## Execution Model

### Sequential Execution
Actions execute in dependency order:
1. Resolve dependencies for each action
2. Execute actions that have all dependencies met
3. Mark action as complete
4. Move to next set of actions

### Parallel Execution (Optional)
Actions within same phase with no inter-dependencies can run in parallel:
- Issue creation (all independent)
- PR creation (all independent)
- Workflow commits (all independent)

### Error Handling
- If action fails: mark as failed, skip dependent actions
- If action is idempotent: allow retry
- If action is reversible: offer rollback

### Resume Support
- Store execution state after each action
- On resume: skip completed actions, retry failed (if idempotent)

## Plan Generation Algorithm

```python
def generate_plan(export_data, transform_data, config):
    plan = Plan()
    
    # Phase 1: Foundation
    plan.add_action(create_repo())
    plan.add_action(push_bundle(), depends_on=[create_repo()])
    
    if has_lfs(export_data):
        plan.add_action(configure_lfs(), depends_on=[push_bundle()])
    
    # Phase 2: CI/CD
    for workflow in transform_data.workflows:
        plan.add_action(commit_workflow(workflow), depends_on=[push_bundle()])
    
    for env in transform_data.environments:
        plan.add_action(create_environment(env), depends_on=[create_repo()])
        for secret in env.secrets:
            plan.add_action(set_secret(secret), depends_on=[create_environment(env)])
    
    # Phase 3: Issues
    for label in export_data.labels:
        plan.add_action(create_label(label), depends_on=[create_repo()])
    
    for issue in export_data.issues:
        deps = [create_repo()]
        if issue.labels:
            deps.extend([create_label(l) for l in issue.labels])
        plan.add_action(create_issue(issue), depends_on=deps)
    
    # ... and so on for all components
    
    # Validate plan
    plan.validate()
    
    return plan
```

## UI Display

### Plan Summary View
```
Migration Plan Summary
======================

Components:
  ✓ Repository (1 action)
  ✓ CI/CD (15 actions)
  ✓ Issues (60 actions)
  ✓ Pull Requests (12 actions)
  ✓ Wiki (1 action)
  ✓ Releases (8 actions)
  ⚠ Packages (3 actions) - requires registry access
  ✓ Settings (5 actions)
  ⚠ Webhooks (1 action) - requires user input

Total: 156 actions
Estimated duration: 45 minutes
User inputs required: 3

[View Detailed Plan] [Review User Inputs] [Execute Plan]
```

### Detailed Plan View
```
Phase 1: Foundation (3 actions, ~2 minutes)
  1. Create repository "org/repo"
  2. Push git bundle (150 MB)
  3. Configure Git LFS (50 objects)

Phase 2: CI/CD Setup (15 actions, ~5 minutes)
  4. Commit workflow: ci.yml
  5. Commit workflow: deploy.yml
  ...
  15. Set secret: DATABASE_URL ⚠ requires input

... (show all phases)

[Download Plan JSON] [Execute with Preview] [Execute Now]
```

## API Endpoint

```
GET /api/runs/{run_id}/plan

Response: plan.json (as shown above)
```

## Success Criteria

✅ Plan is deterministic (same inputs = same plan)
✅ All dependencies are resolvable
✅ No circular dependencies
✅ All required user inputs identified
✅ Idempotency keys prevent duplicates
✅ Execution order is safe
✅ Plan is human-readable
